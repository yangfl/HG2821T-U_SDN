<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<title>中国电信智能网关</title>
		<meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta HTTP-EQUIV='Pragma' CONTENT='no-cache'>
		<link href='<%=resource%>/css/main_style.css?version=<%=version%>' rel='stylesheet' type='text/css'/>
		<script language="javascript" src="<%=resource%>/xhr.js?version=<%=version%>"></script>
		<script language="javascript" src="<%=resource%>/js/util.js?version=<%=version%>"></script>
		<script language="javascript" src="<%=resource%>/js/jquery.js?version=<%=version%>"></script>
	</head>
	<script language="javascript">
	var tcount;
	var allRules;
	var activeTimeout = setTimeout("Timeout()", 300000);    
	  
	function Timeout() {
		(new XHR()).post('<%=luci.dispatcher.build_url('admin/logout')%>',
			{ token: '<%=token%>' }, 
			function(x){
			parent.location = "/cgi-bin/luci";
			});	
	}
		
	function frmLoad()
	{
		(new XHR()).get('<%=luci.dispatcher.build_url('admin/settings/pmDisplay')%>',null,
			function(x, json){
				tcount = json.count;
				allRules = json;
			});					  
	}			
		
	function addPort()
	{
		var inside_port = $("#inside_port").val();
		var external_port = $("#external_port").val();

		$("#error_hint").css("display", "none");
		if ( $("#name").val() == "" )
		{
			$("#error_hint").css("display", "");
			$(".save_error").text("虚拟服务名称不能为空");
			return false;
		}
		
		if (!isValidFileName($("#name").val()))
		{
			$("#error_hint").css("display", "");
			$(".save_error").text("虚拟服务名称含有特殊字符，请修改");
			return false;
		}
				
		var rule;
		for (var i = 0; i < tcount; i++)
		{
			eval("rule = allRules.pmRule" + (i + 1));
			if ($("#name").val() == rule.desp)
			{
			    $("#error_hint").css("display", "");
			    $(".save_error").text("虚拟服务名称已存在");				
				return false;
			}			
		}
				
		if ( !isValidIpAddress($("#ip").val()) )
		{
		    $("#error_hint").css("display", "");
		    $(".save_error").text("局域网IP无效");				
			return false;
		}
		
		if ($("#ip").val() == allRules.lanIp)
		{
		    $("#error_hint").css("display", "");
		    $(".save_error").text("局域网IP与网关IP相同");			
			return false;
		}		

		if ((allRules.lanIp != "0.0.0.0") && (allRules.mask != "0.0.0.0") && !isSameSubNet(allRules.lanIp, allRules.mask, $("#ip").val(), allRules.mask))
		{
		    $("#error_hint").css("display", "");
		    $(".save_error").text("局域网IP与当前局域网不是同一网段");			
			return false;			
		}
		
		if ((inside_port == "") || !isValidPort(inside_port))
		{
		    $("#error_hint").css("display", "");
		    $(".save_error").text("内部端口值无效");				
			return false;
		}
		if ((external_port == "") || !isValidPort(external_port))
		{
		    $("#error_hint").css("display", "");
		    $(".save_error").text("外部端口值无效");				
			return false;
		}

		clearTimeout(activeTimeout);
		activeTimeout = setTimeout("Timeout()", 300000);		
		(new XHR()).post('<%=url('admin/settings/pmSetSingle')%>',
			{ token: '<%=token%>', op: 'add', srvname : $("#name").val(), client : $("#ip").val(), protocol : $("#protocol_value").val(), 
			  exPort : external_port, inPort : inside_port }, 
			function(x){
				if (x.responseText.substr(2, 7) == "DOCTYPE")
  					parent.location = "/cgi-bin/luci";
  				else
  				{			
					$("#name").val("");
					$("#ip").val("");
					$("#protocol_value").val("TCP");
					$("#protocol_value").parent().find("label.select-value").text("TCP");
					$("#inside_port").val("");
					$("#external_port").val("");				
				    var retVal = eval("("+x.responseText+")");
					if (retVal.retVal == 0)
						$(".save_error").text("添加映射已成功");					
					else
						$(".save_error").text("添加映射失败");
						
					$("#error_hint").css("display", "");
      			}
			});		  
	}

	$(document).ready(function(){
		customSelectInit();
	});
	 	
	</script>
	<body onLoad='frmLoad()' onkeydown='parent.kFlg;parent.keycheck(event)' class='main_config_body'>
		<form>
			<div class="main_header">
				<p class="main_header_title">端口映射</p>
				<p class="main_header_hint">您可以通过设置端口映射定义广域网服务端口范围的访问和局域网网络服务器之间的映射关系。</p>
			</div>
			<div class="main_content">
				<div class="main_item">
					<div class="main_item_name">虚拟服务名称</div>
					<div class="main_item_content">
						<input type="text" value="" id="name" class="input_text" autocomplete="off" placeholder="Service" maxlength="31"/>
					</div>
				</div>
				<div class="main_item">
					<div class="main_item_name">局域网IP</div>
					<div class="main_item_content">
						<input type="text" value="" id="ip" class="input_text" autocomplete="off"/>
					</div>
				</div>
				<div class="main_item">
					<div class="main_item_name">服务协议</div>
					<div class="main_item_content">
						<div class="dropdown-select main_item_content_select" hidefocus="true">
							<label class="select-value">TCP</label>
							<input type="hidden" id="protocol_value" value="TCP" />
							<div class="select-arrow"></div>
							<ul id="protocol" class="dropdown-menu-select">
								<li livalue="TCP">TCP</li>
								<li livalue="UDP">UDP</li>
								<li livalue="BOTH">BOTH</li>
							</ul>
						</div>
					</div>
				</div>
				<div class="main_item">
					<div class="main_item_name">内部端口</div>
					<div class="main_item_content">
						<div><input type="text" value="" class="input_text short_input" id="inside_port" maxlength="5" autocomplete="off" placeholder="33333"/></div>
					</div>
				</div>
				<div class="main_item">
					<div class="main_item_name">外部端口</div>
					<div class="main_item_content">
						<div><input type="text" value="" class="input_text short_input" id="external_port" maxlength="5" autocomplete="off" placeholder="33333"/></div>
					</div>
				</div>
				<div id="error_hint" style="margin-left: 130px; display:none">
					<div class="save_error" style="color: #535353;">
					</div>
				</div>				
			</div>
			<div class="main_save">
				<input type="button" class="input_button" value="添加映射" onclick="addPort()"/>
			</div>
		</form>
	</body>
</html>
